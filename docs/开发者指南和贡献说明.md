# LightRAG 开发者指南和贡献说明

## 概述

欢迎参与 LightRAG 项目开发！本指南介绍开发环境设置、编码规范、测试方法和贡献流程。

## 快速开始

### 1. 开发环境设置

```bash
# 克隆项目
git clone https://github.com/HKUDS/LightRAG.git
cd LightRAG

# 创建虚拟环境
python -m venv lightrag-dev
source lightrag-dev/bin/activate  # Linux/Mac
# lightrag-dev\Scripts\activate  # Windows

# 安装开发依赖
pip install -e ".[api]"
pip install black isort flake8 pytest mypy pre-commit

# 配置开发环境
cp env.example .env.dev
echo "OPENAI_API_KEY=your-dev-key" >> .env.dev
echo "LOG_LEVEL=DEBUG" >> .env.dev

# 安装 pre-commit hooks
pre-commit install

# 启动开发服务器
export DOTENV_PATH=.env.dev
lightrag-server --host 0.0.0.0 --port 8020 --log-level DEBUG
```

### 2. 项目结构

```
LightRAG/
├── lightrag/                    # 核心模块
│   ├── lightrag.py              # 主 LightRAG 类
│   ├── base.py                  # 基础抽象类
│   ├── operate.py               # 核心操作逻辑
│   ├── utils.py                 # 工具函数
│   ├── api/                     # API 服务
│   │   ├── lightrag_server.py   # FastAPI 服务器
│   │   └── routers/             # API 路由
│   ├── kg/                      # 存储实现
│   │   ├── json_kv_impl.py      # JSON 存储
│   │   ├── neo4j_impl.py        # Neo4j 存储
│   │   └── ...                  # 其他存储
│   └── llm/                     # LLM 集成
├── lightrag_webui/              # Web UI 前端
├── tests/                       # 测试代码
├── examples/                    # 示例代码
└── docs/                        # 文档
```

## 开发规范

### 1. 代码风格

#### Python 代码
```bash
# 格式化代码
black lightrag/ tests/

# 排序导入
isort lightrag/ tests/

# 代码质量检查
flake8 lightrag/ tests/

# 类型检查
mypy lightrag/
```

#### 配置文件
```toml
# pyproject.toml
[tool.black]
line-length = 88
target-version = ['py310']

[tool.isort]
profile = "black"
multi_line_output = 3

[tool.mypy]
python_version = "3.10"
warn_return_any = true
disallow_untyped_defs = true
```

### 2. 测试指南

#### 编写测试
```python
# tests/test_lightrag.py
import pytest
from lightrag import LightRAG

@pytest.fixture
def lightrag_instance():
    return LightRAG(
        working_dir="./test_storage",
        embedding_func=mock_embedding_func,
        llm_model_func=mock_llm_func
    )

async def test_insert_and_query(lightrag_instance):
    await lightrag_instance.initialize_storages()
    
    # 测试插入
    await lightrag_instance.ainsert("测试文档")
    
    # 测试查询
    result = await lightrag_instance.aquery("测试查询")
    assert isinstance(result, str)
    
    await lightrag_instance.finalize_storages()
```

#### 运行测试
```bash
# 所有测试
pytest

# 特定测试
pytest tests/test_lightrag.py::test_insert_and_query

# 覆盖率
pytest --cov=lightrag --cov-report=html

# 标记测试
pytest -m "not slow"
```

## 扩展开发

### 1. 添加存储后端

```python
# lightrag/kg/custom_storage.py
from dataclasses import dataclass
from lightrag.base import BaseVectorStorage

@dataclass
class CustomVectorStorage(BaseVectorStorage):
    async def query(self, query: str, top_k: int) -> list[dict]:
        # 实现查询逻辑
        pass
    
    async def upsert(self, data: dict) -> None:
        # 实现插入逻辑
        pass

# 注册存储
# lightrag/kg/__init__.py
STORAGES["CustomVectorStorage"] = ".kg.custom_storage"
```

### 2. 添加 API 端点

```python
# lightrag/api/routers/custom_routes.py
from fastapi import APIRouter
from pydantic import BaseModel

router = APIRouter(tags=["custom"])

class CustomRequest(BaseModel):
    data: str

@router.post("/custom/process")
async def process_data(request: CustomRequest):
    # 处理逻辑
    return {"result": f"Processed: {request.data}"}

# 注册到主应用
# lightrag/api/lightrag_server.py
from .routers.custom_routes import router as custom_router
app.include_router(custom_router, prefix="/api")
```

### 3. 添加 Web UI 组件

```typescript
// lightrag_webui/src/components/CustomComponent.tsx
import React, { useState } from 'react'
import Button from '@/components/ui/Button'

export default function CustomComponent() {
  const [data, setData] = useState('')

  const handleProcess = async () => {
    const response = await fetch('/api/custom/process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ data })
    })
    const result = await response.json()
    console.log(result)
  }

  return (
    <div>
      <input 
        value={data} 
        onChange={(e) => setData(e.target.value)}
        placeholder="输入数据" 
      />
      <Button onClick={handleProcess}>处理</Button>
    </div>
  )
}
```

## 贡献流程

### 1. 报告问题

使用 GitHub Issues，包含：
- 问题描述
- 重现步骤
- 环境信息
- 错误日志

### 2. 提交代码

```bash
# 1. Fork 项目
# 2. 创建分支
git checkout -b feature/your-feature

# 3. 开发和测试
# 编写代码
# 运行测试
pytest
black lightrag/
isort lightrag/

# 4. 提交
git add .
git commit -m "feat: 添加新功能"
git push origin feature/your-feature

# 5. 创建 Pull Request
```

### 3. Pull Request 规范

#### 标题格式
- `feat: 添加新功能`
- `fix: 修复bug`
- `docs: 更新文档`
- `style: 代码格式`
- `refactor: 重构代码`
- `test: 添加测试`

#### PR 模板
```markdown
## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 文档更新
- [ ] 代码重构

## 变更描述
简要描述本次变更的内容和原因

## 测试
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 手动测试完成

## 相关 Issue
Closes #123
```

### 4. 代码审查

#### 审查清单
- [ ] 代码符合项目规范
- [ ] 测试覆盖率充足
- [ ] 文档更新完整
- [ ] 向后兼容性
- [ ] 性能影响评估

#### 常见问题
- 缺少类型注解
- 未添加测试
- 硬编码配置
- 内存泄漏风险
- API 兼容性破坏

## 最佳实践

### 1. 性能优化

```python
# 使用异步操作
async def process_documents(docs):
    tasks = [process_single_doc(doc) for doc in docs]
    return await asyncio.gather(*tasks)

# 批量操作
async def batch_insert(items, batch_size=100):
    for i in range(0, len(items), batch_size):
        batch = items[i:i + batch_size]
        await insert_batch(batch)

# 缓存结果
from functools import lru_cache

@lru_cache(maxsize=1000)
def expensive_function(input_data):
    return compute_result(input_data)
```

### 2. 错误处理

```python
from lightrag.exceptions import LightRAGError

class CustomError(LightRAGError):
    """自定义错误类"""
    pass

async def safe_operation():
    try:
        result = await risky_operation()
        return result
    except SpecificError as e:
        logger.error(f"操作失败: {e}")
        raise CustomError(f"自定义错误: {e}") from e
    except Exception as e:
        logger.exception("未预期的错误")
        raise
```

### 3. 日志规范

```python
import logging
from lightrag.utils import logger

# 使用项目日志器
logger.info("操作开始")
logger.debug(f"处理数据: {data}")
logger.warning("检测到潜在问题")
logger.error(f"操作失败: {error}")

# 结构化日志
logger.info("文档处理完成", extra={
    "document_id": doc_id,
    "processing_time": elapsed_time,
    "chunks_created": chunk_count
})
```

### 4. 配置管理

```python
# 使用环境变量
import os
from lightrag.utils import get_env_value

# 获取配置
api_key = get_env_value("OPENAI_API_KEY", None)
max_tokens = get_env_value("MAX_TOKENS", 32000, int)
enable_cache = get_env_value("ENABLE_CACHE", True, bool)

# 验证必需配置
if not api_key:
    raise ValueError("OPENAI_API_KEY is required")
```

## 发布流程

### 1. 版本管理

```bash
# 更新版本号
# lightrag/__init__.py
__version__ = "1.5.0"

# 创建标签
git tag v1.5.0
git push origin v1.5.0
```

### 2. 发布检查

- [ ] 所有测试通过
- [ ] 文档更新完整
- [ ] 变更日志更新
- [ ] 版本号递增
- [ ] 兼容性检查

### 3. PyPI 发布

```bash
# 构建包
python -m build

# 发布到 PyPI
python -m twine upload dist/*
```

## 社区参与

### 1. 沟通渠道

- **GitHub Issues**: 问题报告和功能请求
- **GitHub Discussions**: 技术讨论和问答
- **Pull Requests**: 代码贡献和审查

### 2. 贡献类型

- **代码贡献**: 新功能、Bug 修复、性能优化
- **文档贡献**: API 文档、使用指南、示例代码
- **测试贡献**: 单元测试、集成测试、性能测试
- **问题反馈**: Bug 报告、功能建议、使用体验

### 3. 社区准则

- 尊重他人，友善交流
- 提供建设性反馈
- 遵循项目规范
- 积极参与讨论
- 帮助新贡献者

## 获取帮助

### 1. 文档资源

- [项目概述和架构](./项目概述和架构.md)
- [API接口文档](./API接口文档.md)
- [核心模块文档](./核心模块和存储系统文档.md)
- [部署指南](./部署和配置指南.md)

### 2. 示例代码

查看 `examples/` 目录中的示例：
- `lightrag_openai_demo.py`: OpenAI 集成示例
- `lightrag_ollama_demo.py`: Ollama 集成示例
- `lightrag_storage_demo.py`: 存储后端示例

### 3. 联系方式

- GitHub Issues: 技术问题和 Bug 报告
- GitHub Discussions: 功能讨论和经验分享
- Email: 项目维护者邮箱（仅紧急问题）

感谢您的贡献，让我们一起让 LightRAG 变得更好！