# LightRAG 部署和配置指南

## 概述

LightRAG 支持多种部署方式，从简单的本地开发到生产级的分布式部署。本指南将详细介绍各种部署选项、配置参数和最佳实践。

## 快速开始

### 1. PyPI 安装

```bash
# 安装核心版本
pip install lightrag-hku

# 安装包含 API 服务的完整版本
pip install "lightrag-hku[api]"

# 启动服务器
lightrag-server
```

### 2. 源码安装

```bash
# 克隆仓库
git clone https://github.com/HKUDS/LightRAG.git
cd LightRAG

# 创建虚拟环境（推荐）
python -m venv lightrag-env
source lightrag-env/bin/activate  # Linux/Mac
# lightrag-env\Scripts\activate  # Windows

# 安装依赖
pip install -e ".[api]"

# 配置环境变量
cp env.example .env
# 编辑 .env 文件

# 启动服务器
lightrag-server
```

### 3. Docker 快速部署

```bash
# 使用 Docker Compose
git clone https://github.com/HKUDS/LightRAG.git
cd LightRAG
cp env.example .env
# 编辑 .env 配置文件
docker compose up -d
```

## 环境配置

### 1. 环境变量配置

#### 核心配置
```bash
# API 密钥配置
OPENAI_API_KEY=sk-your-openai-api-key
JINA_API_KEY=your-jina-api-key

# 服务器配置
HOST=0.0.0.0
PORT=9621
WORKERS=1

# 工作目录
WORKING_DIR=./rag_storage
INPUT_DIR=./inputs
WORKSPACE=default

# 日志配置
LOG_LEVEL=INFO
VERBOSE=false
```

#### LLM 配置
```bash
# LLM 绑定类型
LLM_BINDING=openai
LLM_BINDING_HOST=https://api.openai.com/v1
LLM_MODEL=gpt-4o-mini

# 嵌入模型配置
EMBEDDING_BINDING=openai
EMBEDDING_MODEL=text-embedding-3-small
EMBEDDING_DIM=1536

# 模型参数
MAX_ASYNC=4
MAX_TOKENS=32000
TIMEOUT=150
```

#### 查询配置
```bash
# 检索参数
TOP_K=60
CHUNK_TOP_K=10
MAX_ENTITY_TOKENS=10000
MAX_RELATION_TOKENS=10000
MAX_TOTAL_TOKENS=32000
HISTORY_TURNS=3

# 向量检索
COSINE_THRESHOLD=0.2
RELATED_CHUNK_NUMBER=5

# 文档分块
CHUNK_SIZE=1200
CHUNK_OVERLAP_SIZE=100

# 重排序
ENABLE_RERANK=true
```

#### 存储配置
```bash
# 存储类型
KV_STORAGE=JsonKVStorage
VECTOR_STORAGE=NanoVectorDBStorage
GRAPH_STORAGE=NetworkXStorage
DOC_STATUS_STORAGE=JsonDocStatusStorage

# Redis 配置
REDIS_URI=redis://localhost:6379/0
REDIS_WORKSPACE=lightrag

# PostgreSQL 配置
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=lightrag
POSTGRES_PASSWORD=your-password
POSTGRES_DATABASE=lightrag
POSTGRES_WORKSPACE=lightrag

# Neo4j 配置
NEO4J_URI=neo4j://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your-password
NEO4J_WORKSPACE=lightrag

# Milvus 配置
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_WORKSPACE=lightrag

# Qdrant 配置
QDRANT_URL=http://localhost:6333
QDRANT_API_KEY=your-api-key
QDRANT_WORKSPACE=lightrag
```

#### Web UI 配置
```bash
# UI 定制
WEBUI_TITLE=LightRAG Knowledge Graph
WEBUI_DESCRIPTION=Retrieval-Augmented Generation with Knowledge Graph

# CORS 配置
CORS_ORIGINS=*

# 认证配置
LIGHTRAG_API_KEY=your-secret-key
```

### 2. 配置文件

#### 环境变量文件 (`.env`)
```bash
# 复制示例文件
cp env.example .env

# 编辑配置
nano .env
```

**完整的 `.env` 示例**：
```bash
# ==================== API 密钥 ====================
OPENAI_API_KEY=sk-your-openai-api-key-here
JINA_API_KEY=your-jina-api-key-here

# ==================== 服务器配置 ====================
HOST=0.0.0.0
PORT=9621
WORKERS=1
LIGHTRAG_API_KEY=your-secret-api-key

# ==================== 目录配置 ====================
WORKING_DIR=./data/rag_storage
INPUT_DIR=./data/inputs
WORKSPACE=production

# ==================== LLM 配置 ====================
LLM_BINDING=openai
LLM_MODEL=gpt-4o-mini
EMBEDDING_BINDING=openai
EMBEDDING_MODEL=text-embedding-3-small

# ==================== 存储配置 ====================
KV_STORAGE=JsonKVStorage
VECTOR_STORAGE=NanoVectorDBStorage
GRAPH_STORAGE=NetworkXStorage
DOC_STATUS_STORAGE=JsonDocStatusStorage

# ==================== 性能配置 ====================
MAX_ASYNC=4
MAX_TOKENS=32000
TOP_K=60
CHUNK_TOP_K=10

# ==================== 日志配置 ====================
LOG_LEVEL=INFO
VERBOSE=false

# ==================== Web UI 配置 ====================
WEBUI_TITLE=My LightRAG Instance
WEBUI_DESCRIPTION=Personal Knowledge Graph System
CORS_ORIGINS=*
```

## 部署方式

### 1. 本地开发部署

#### 基础部署
```bash
# 安装依赖
pip install "lightrag-hku[api]"

# 创建配置文件
echo "OPENAI_API_KEY=your-key-here" > .env

# 启动服务
lightrag-server --host 0.0.0.0 --port 8020
```

#### 开发模式
```bash
# 克隆源码
git clone https://github.com/HKUDS/LightRAG.git
cd LightRAG

# 安装开发依赖
pip install -e ".[api]"

# 启动开发服务器（自动重载）
lightrag-server --host 0.0.0.0 --port 8020 --reload --log-level DEBUG
```

### 2. Docker 部署

#### 单容器部署
```bash
# 构建镜像
docker build -t lightrag:latest .

# 运行容器
docker run -d \
  --name lightrag \
  -p 9621:9621 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/.env:/app/.env \
  lightrag:latest
```

#### Docker Compose 部署
```yaml
# docker-compose.yml
services:
  lightrag:
    container_name: lightrag
    image: ghcr.io/hkuds/lightrag:latest
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-9621}:9621"
    volumes:
      - ./data/rag_storage:/app/data/rag_storage
      - ./data/inputs:/app/data/inputs
      - ./.env:/app/.env
    env_file:
      - .env
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # 可选：添加 Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  # 可选：添加 PostgreSQL
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: lightrag
      POSTGRES_USER: lightrag
      POSTGRES_PASSWORD: your-password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  redis_data:
  postgres_data:
```

```bash
# 启动服务
docker compose up -d

# 查看日志
docker compose logs -f lightrag

# 停止服务
docker compose down
```

### 3. 生产环境部署

#### 使用 Nginx 反向代理
```nginx
# /etc/nginx/sites-available/lightrag
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书配置
    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 客户端最大请求体大小
    client_max_body_size 100M;

    # 代理 LightRAG 服务
    location / {
        proxy_pass http://127.0.0.1:9621;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态文件缓存
    location /webui/assets/ {
        proxy_pass http://127.0.0.1:9621;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 使用 Systemd 服务
```ini
# /etc/systemd/system/lightrag.service
[Unit]
Description=LightRAG Server
After=network.target

[Service]
Type=simple
User=lightrag
Group=lightrag
WorkingDirectory=/opt/lightrag
Environment=PATH=/opt/lightrag/venv/bin
ExecStart=/opt/lightrag/venv/bin/lightrag-server --host 0.0.0.0 --port 9621
Restart=always
RestartSec=10

# 安全设置
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/lightrag/data

[Install]
WantedBy=multi-user.target
```

```bash
# 启用并启动服务
sudo systemctl enable lightrag
sudo systemctl start lightrag
sudo systemctl status lightrag
```

#### 使用 Gunicorn 部署
```python
# gunicorn_config.py
bind = "0.0.0.0:9621"
workers = 4
worker_class = "uvicorn.workers.UvicornWorker"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100
timeout = 300
keepalive = 5
preload_app = True

# 日志配置
accesslog = "/var/log/lightrag/access.log"
errorlog = "/var/log/lightrag/error.log"
loglevel = "info"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'
```

```bash
# 使用 Gunicorn 启动
gunicorn -c gunicorn_config.py lightrag.api.lightrag_server:app
```

### 4. Kubernetes 部署

#### 部署清单
```yaml
# lightrag-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lightrag
  labels:
    app: lightrag
spec:
  replicas: 3
  selector:
    matchLabels:
      app: lightrag
  template:
    metadata:
      labels:
        app: lightrag
    spec:
      containers:
      - name: lightrag
        image: ghcr.io/hkuds/lightrag:latest
        ports:
        - containerPort: 9621
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: lightrag-secrets
              key: openai-api-key
        - name: LIGHTRAG_API_KEY
          valueFrom:
            secretKeyRef:
              name: lightrag-secrets
              key: lightrag-api-key
        - name: HOST
          value: "0.0.0.0"
        - name: PORT
          value: "9621"
        - name: REDIS_URI
          value: "redis://redis:6379/0"
        - name: POSTGRES_HOST
          value: "postgres"
        - name: POSTGRES_USER
          value: "lightrag"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: lightrag-secrets
              key: postgres-password
        volumeMounts:
        - name: data-volume
          mountPath: /app/data
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 9621
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 9621
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: lightrag-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: lightrag-service
spec:
  selector:
    app: lightrag
  ports:
  - protocol: TCP
    port: 80
    targetPort: 9621
  type: LoadBalancer

---
apiVersion: v1
kind: Secret
metadata:
  name: lightrag-secrets
type: Opaque
stringData:
  openai-api-key: "sk-your-openai-api-key-here"
  lightrag-api-key: "your-lightrag-api-key-here"
  postgres-password: "your-postgres-password-here"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: lightrag-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
```

```bash
# 部署到 Kubernetes
kubectl apply -f lightrag-deployment.yaml

# 查看部署状态
kubectl get pods -l app=lightrag
kubectl get svc lightrag-service

# 查看日志
kubectl logs -f deployment/lightrag
```

## 存储后端配置

### 1. 本地存储（默认）

```bash
# 环境变量
KV_STORAGE=JsonKVStorage
VECTOR_STORAGE=NanoVectorDBStorage
GRAPH_STORAGE=NetworkXStorage
DOC_STATUS_STORAGE=JsonDocStatusStorage
WORKING_DIR=./rag_storage
```

**目录结构**：
```
rag_storage/
├── kv_store_chunks.json
├── kv_store_llm_response_cache.json
├── nanodb_chunks.json
├── nanodb_entities.json
├── nanodb_relationships.json
├── nx_graph_chunks.pkl
└── doc_status.json
```

### 2. Redis 存储

```bash
# 安装 Redis
sudo apt install redis-server
# 或使用 Docker
docker run -d --name redis -p 6379:6379 redis:alpine

# 环境变量配置
KV_STORAGE=RedisKVStorage
DOC_STATUS_STORAGE=RedisDocStatusStorage
REDIS_URI=redis://localhost:6379/0
REDIS_PASSWORD=your-password  # 可选
REDIS_WORKSPACE=lightrag
```

### 3. PostgreSQL 存储

```bash
# 安装 PostgreSQL
sudo apt install postgresql postgresql-contrib
# 或使用 Docker
docker run -d --name postgres \
  -e POSTGRES_DB=lightrag \
  -e POSTGRES_USER=lightrag \
  -e POSTGRES_PASSWORD=your-password \
  -p 5432:5432 \
  postgres:15

# 创建扩展
sudo -u postgres psql lightrag -c "CREATE EXTENSION IF NOT EXISTS vector;"
sudo -u postgres psql lightrag -c "CREATE EXTENSION IF NOT EXISTS age;"

# 环境变量配置
KV_STORAGE=PGKVStorage
VECTOR_STORAGE=PGVectorStorage
GRAPH_STORAGE=PGGraphStorage
DOC_STATUS_STORAGE=PGDocStatusStorage

POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=lightrag
POSTGRES_PASSWORD=your-password
POSTGRES_DATABASE=lightrag
POSTGRES_WORKSPACE=lightrag
```

### 4. Neo4j 图数据库

```bash
# 使用 Docker 启动 Neo4j
docker run -d --name neo4j \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/your-password \
  -e NEO4J_PLUGINS='["apoc"]' \
  neo4j:latest

# 环境变量配置
GRAPH_STORAGE=Neo4JStorage
NEO4J_URI=neo4j://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your-password
NEO4J_WORKSPACE=lightrag
```

### 5. Milvus 向量数据库

```bash
# 使用 Docker Compose 启动 Milvus
wget https://github.com/milvus-io/milvus/releases/download/v2.3.0/milvus-standalone-docker-compose.yml -O docker-compose.yml
docker compose up -d

# 环境变量配置
VECTOR_STORAGE=MilvusVectorDBStorage
MILVUS_HOST=localhost
MILVUS_PORT=19530
MILVUS_WORKSPACE=lightrag
```

### 6. 混合存储配置

```bash
# 示例：高性能生产配置
KV_STORAGE=RedisKVStorage              # Redis 用于快速 KV 访问
VECTOR_STORAGE=MilvusVectorDBStorage   # Milvus 用于大规模向量检索
GRAPH_STORAGE=Neo4JStorage             # Neo4j 用于复杂图查询
DOC_STATUS_STORAGE=PGDocStatusStorage  # PostgreSQL 用于可靠状态存储

# Redis 配置
REDIS_URI=redis://redis-cluster:6379/0

# Milvus 配置
MILVUS_HOST=milvus-server
MILVUS_PORT=19530

# Neo4j 配置
NEO4J_URI=neo4j://neo4j-server:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=your-password

# PostgreSQL 配置
POSTGRES_HOST=postgres-server
POSTGRES_USER=lightrag
POSTGRES_PASSWORD=your-password
POSTGRES_DATABASE=lightrag
```

## 性能优化

### 1. 硬件要求

#### 最低配置
- **CPU**: 2 核心
- **内存**: 4GB RAM
- **存储**: 10GB 可用空间
- **网络**: 稳定的互联网连接（用于 LLM API）

#### 推荐配置
- **CPU**: 4+ 核心
- **内存**: 8GB+ RAM
- **存储**: 50GB+ SSD
- **GPU**: 可选，用于本地 LLM 推理

#### 生产环境配置
- **CPU**: 8+ 核心
- **内存**: 16GB+ RAM
- **存储**: 100GB+ NVMe SSD
- **网络**: 高带宽，低延迟

### 2. 性能调优

#### 并发配置
```bash
# 增加异步并发数
MAX_ASYNC=8

# 增加工作进程数
WORKERS=4

# 调整批处理大小
EMBEDDING_BATCH_NUM=64
```

#### 缓存配置
```bash
# 启用 LLM 缓存
ENABLE_LLM_CACHE=true

# 启用实体提取缓存
ENABLE_LLM_CACHE_FOR_ENTITY_EXTRACT=true

# 配置查询缓存
ENABLE_QUERY_CACHE=true
QUERY_CACHE_TTL=3600
```

#### 内存优化
```bash
# 限制文档分块大小
CHUNK_SIZE=800
CHUNK_OVERLAP_SIZE=80

# 限制检索数量
TOP_K=40
CHUNK_TOP_K=8

# 限制 Token 使用
MAX_ENTITY_TOKENS=8000
MAX_RELATION_TOKENS=8000
MAX_TOTAL_TOKENS=24000
```

### 3. 监控和日志

#### 日志配置
```bash
# 详细日志
LOG_LEVEL=DEBUG
VERBOSE=true

# 日志文件设置
LOG_DIR=/var/log/lightrag
LOG_MAX_BYTES=10485760
LOG_BACKUP_COUNT=5
```

#### 健康检查
```bash
# 检查服务状态
curl http://localhost:9621/health

# 检查 API 状态
curl -H "Authorization: Bearer your-api-key" \
     http://localhost:9621/documents/pipeline_status
```

#### 监控指标
```python
# 在代码中添加监控
from lightrag.utils import statistic_data

# 查看统计信息
print(f"LLM 调用次数: {statistic_data['llm_call']}")
print(f"LLM 缓存命中: {statistic_data['llm_cache']}")
print(f"嵌入调用次数: {statistic_data['embed_call']}")
```

## 安全配置

### 1. API 密钥保护

```bash
# 设置强密码
LIGHTRAG_API_KEY=$(openssl rand -base64 32)

# 使用环境变量而非配置文件
export LIGHTRAG_API_KEY="your-secret-key"
```

### 2. HTTPS 配置

```bash
# 生成自签名证书（仅用于测试）
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# 启用 HTTPS
lightrag-server --ssl --ssl-certfile cert.pem --ssl-keyfile key.pem
```

### 3. 网络安全

```bash
# 限制访问来源
CORS_ORIGINS=https://your-domain.com,https://another-domain.com

# 配置防火墙
sudo ufw allow 9621/tcp
sudo ufw enable
```

### 4. 数据安全

```bash
# 设置文件权限
chmod 600 .env
chmod 700 data/

# 定期备份
rsync -av data/ backup/$(date +%Y%m%d)/
```

## 故障排除

### 1. 常见问题

#### 服务启动失败
```bash
# 检查端口占用
netstat -tlnp | grep 9621

# 检查日志
tail -f logs/lightrag.log

# 检查配置
lightrag-server --help
```

#### 存储连接问题
```bash
# 测试 Redis 连接
redis-cli -u redis://localhost:6379 ping

# 测试 PostgreSQL 连接
psql -h localhost -U lightrag -d lightrag -c "SELECT 1;"

# 测试 Neo4j 连接
cypher-shell -a neo4j://localhost:7687 -u neo4j
```

#### API 调用失败
```bash
# 检查 API 密钥
curl -H "Authorization: Bearer wrong-key" http://localhost:9621/health

# 检查网络连接
curl -v http://localhost:9621/health

# 检查 CORS 配置
curl -H "Origin: https://example.com" http://localhost:9621/health
```

### 2. 性能问题

#### 响应缓慢
```bash
# 检查系统资源
htop
df -h
free -h

# 检查数据库性能
# Redis
redis-cli info stats

# PostgreSQL
sudo -u postgres psql -c "SELECT * FROM pg_stat_activity;"
```

#### 内存使用过高
```bash
# 减少并发数
MAX_ASYNC=2
WORKERS=1

# 减少缓存大小
MAX_ENTITY_TOKENS=5000
MAX_RELATION_TOKENS=5000

# 清理缓存
curl -X DELETE http://localhost:9621/documents/clear_cache
```

### 3. 数据问题

#### 数据丢失
```bash
# 检查备份
ls -la backup/

# 恢复数据
rsync -av backup/latest/ data/

# 重建索引
curl -X POST http://localhost:9621/documents/rebuild_index
```

#### 索引损坏
```bash
# 清理并重建
rm -rf data/nanodb_*.json
rm -rf data/nx_graph_*.pkl
curl -X POST http://localhost:9621/documents/scan
```

这份部署和配置指南为不同场景的 LightRAG 部署提供了详细的说