# LightRAG 项目概述与架构文档

## 项目简介

LightRAG 是一个简单快速的检索增强生成（Retrieval-Augmented Generation）系统，提供了完整的 RAG 解决方案，包括知识图谱构建、向量检索、Web UI 和 API 服务。

### 核心特性

- **多模式检索**：支持 local、global、hybrid、naive、mix、bypass 等查询模式
- **知识图谱**：基于实体和关系的图数据库存储
- **向量检索**：支持多种向量数据库后端
- **多存储支持**：支持多种数据库（Redis、PostgreSQL、Neo4j、MongoDB、Milvus 等）
- **Web UI**：现代化的 React 前端界面
- **API 服务**：完整的 REST API 和 Ollama 兼容接口
- **多语言支持**：国际化界面，支持中英文等多种语言

### 版本信息

- **核心版本**：1.4.5
- **API 版本**：由 `lightrag.api.__api_version__` 定义
- **许可证**：MIT
- **Python 版本要求**：>=3.10

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        LightRAG System                          │
├─────────────────────────────────────────────────────────────────┤
│                         Web UI Layer                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   React WebUI   │  │   API Docs      │  │   Static Files  │ │
│  │   (TypeScript)  │  │   (Swagger)     │  │   (Assets)      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                         API Layer                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ FastAPI Server  │  │ Document Routes │  │  Query Routes   │ │
│  │   (lightrag_    │  │   (CRUD Docs)   │  │  (RAG Queries)  │ │
│  │    server.py)   │  └─────────────────┘  └─────────────────┘ │
│  └─────────────────┘  ┌─────────────────┐  ┌─────────────────┐ │
│  ┌─────────────────┐  │  Graph Routes   │  │  Ollama API     │ │
│  │  Auth & Config  │  │ (KG Management) │  │ (Compatibility) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                        Core Engine                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   LightRAG      │  │    Operate      │  │     Utils       │ │
│  │   (lightrag.py) │  │   (operate.py)  │  │   (utils.py)    │ │
│  │  - Query Logic  │  │ - Entity Ext.   │  │ - Tokenization  │ │
│  │  - Initialize   │  │ - Chunking      │  │ - Embedding     │ │
│  │  - Insert       │  │ - KG Building   │  │ - Caching       │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                       Storage Layer                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   KV Storage    │  │  Vector Storage │  │  Graph Storage  │ │
│  │  - JSON/Redis   │  │ - Nano/Milvus   │  │ - NetworkX/Neo4j│ │
│  │  - PostgreSQL   │  │ - Faiss/Qdrant  │  │ - PostgreSQL    │ │
│  │  - MongoDB      │  │ - PostgreSQL    │  │ - Memgraph      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│  ┌─────────────────┐                                           │
│  │ Doc Status      │                                           │
│  │ Storage         │                                           │
│  │ - JSON/Redis    │                                           │
│  │ - PostgreSQL    │                                           │
│  │ - MongoDB       │                                           │
│  └─────────────────┘                                           │
├─────────────────────────────────────────────────────────────────┤
│                      External Services                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   LLM Services  │  │ Embedding APIs  │  │  Rerank APIs    │ │
│  │  - OpenAI       │  │ - OpenAI        │  │ - Jina          │ │
│  │  - Ollama       │  │ - Jina          │  │ - BGE           │ │
│  │  - HuggingFace  │  │ - BGE           │  │                 │ │
│  │  - Azure        │  │ - SiliconCloud  │  │                 │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 核心组件说明

#### 1. Web UI Layer

- **React WebUI**: 使用 TypeScript + React + Vite 构建的现代化前端
- **组件结构**:
  - `components/`: 可复用的 UI 组件
  - `features/`: 功能特性模块（文档管理、图谱查看、检索测试等）
  - `stores/`: 状态管理（Zustand）
  - `contexts/`: React Context 提供者
  - `hooks/`: 自定义 React Hooks

#### 2. API Layer

- **FastAPI Server**: 基于 FastAPI 的 Web 服务器
- **路由模块**:
  - `document_routes.py`: 文档管理 API
  - `query_routes.py`: 查询检索 API
  - `graph_routes.py`: 知识图谱管理 API
  - `ollama_api.py`: Ollama 兼容 API

#### 3. Core Engine

- **LightRAG**: 主核心类，提供统一的 RAG 接口
- **Operate**: 操作模块，处理实体提取、分块、知识图谱构建
- **Utils**: 工具模块，提供通用功能函数

#### 4. Storage Layer

LightRAG 支持四种存储类型：

1. **KV Storage**: 键值存储，用于文档和文本块
2. **Vector Storage**: 向量存储，用于嵌入向量
3. **Graph Storage**: 图存储，用于知识图谱
4. **Doc Status Storage**: 文档状态存储，跟踪处理状态

### 数据流架构

#### 文档索引流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Document   │───▶│   Chunking   │───▶│ Entity Ext. │
│   Upload     │    │   (Token)    │    │   (LLM)     │
└─────────────┘    └─────────────┘    └─────────────┘
                                              │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Vector     │◀───│  Embedding   │◀───│ Relation    │
│   Storage    │    │   (API)      │    │ Extraction  │
└─────────────┘    └─────────────┘    └─────────────┘
                                              │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Graph      │◀───│ KG Building  │◀───┘
│   Storage    │    │   (Merge)    │
└─────────────┘    └─────────────┘
```

#### 查询检索流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ User Query  │───▶│Query Analysis│───▶│Mode Selection│
└─────────────┘    └─────────────┘    └─────────────┘
                                              │
              ┌─────────────────────────────────┼─────────────────────────────────┐
              │                                 │                                 │
              ▼                                 ▼                                 ▼
    ┌─────────────┐                  ┌─────────────┐                  ┌─────────────┐
    │   Local     │                  │   Global    │                  │   Hybrid    │
    │  (Entities) │                  │(Relations)  │                  │  (Combined) │
    └─────────────┘                  └─────────────┘                  └─────────────┘
              │                                 │                                 │
              └─────────────────────────────────┼─────────────────────────────────┘
                                              │
                                              ▼
                                    ┌─────────────┐
                                    │ Context     │
                                    │ Assembly    │
                                    └─────────────┘
                                              │
                                              ▼
                                    ┌─────────────┐
                                    │ LLM         │
                                    │ Generation  │
                                    └─────────────┘
```

### 配置与环境

#### 环境变量配置

LightRAG 支持通过环境变量进行配置：

- **API Keys**: `OPENAI_API_KEY`, `JINA_API_KEY` 等
- **存储配置**: `REDIS_URL`, `NEO4J_URI`, `POSTGRES_URL` 等
- **系统参数**: `TOP_K`, `CHUNK_SIZE`, `MAX_TOKENS` 等
- **工作空间**: `WORKSPACE` 用于数据隔离

#### 配置文件

- `.env`: 环境变量配置文件
- `config.ini`: 配置文件（正在逐步弃用）

### 扩展性设计

#### 存储适配器模式

LightRAG 使用适配器模式支持多种存储后端：

```python
# 基础抽象类
class BaseVectorStorage(StorageNameSpace, ABC):
    @abstractmethod
    async def query(self, query: str, top_k: int) -> list[dict]:
        pass
    
    @abstractmethod
    async def upsert(self, data: dict) -> None:
        pass

# 具体实现
class MilvusVectorDBStorage(BaseVectorStorage):
    # Milvus 具体实现
    pass

class QdrantVectorDBStorage(BaseVectorStorage):
    # Qdrant 具体实现
    pass
```

#### LLM 提供商集成

支持多种 LLM 提供商：

- **OpenAI**: GPT-4、GPT-3.5 等
- **Ollama**: 本地部署模型
- **Azure OpenAI**: 企业级 OpenAI 服务
- **HuggingFace**: 开源模型
- **其他**: Anthropic、Bedrock、智谱等

### 性能优化

#### 并发处理

- **异步操作**: 全面使用 `async/await` 模式
- **并行处理**: 支持批量文档并行索引
- **连接池**: 数据库连接池管理

#### 缓存机制

- **LLM 缓存**: 缓存 LLM 响应，避免重复调用
- **嵌入缓存**: 缓存向量嵌入结果
- **查询缓存**: 缓存查询结果

#### 内存管理

- **流式处理**: 大文档流式分块处理
- **内存释放**: 及时释放不需要的资源
- **批量操作**: 批量数据库操作减少 I/O

## 部署架构

### 单机部署

```
┌─────────────────────────────────────────┐
│              Single Server               │
│  ┌─────────────┐  ┌─────────────────────┐│
│  │  LightRAG   │  │    Web UI + API     ││
│  │   Server    │  │   (FastAPI/React)   ││
│  └─────────────┘  └─────────────────────┘│
│  ┌─────────────────────────────────────┐ │
│  │           Local Storage             │ │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │ │
│  │  │JSON │ │Nano │ │NetX │ │JSON │   │ │
│  │  │ KV  │ │Vec  │ │Graph│ │Doc  │   │ │
│  │  └─────┘ └─────┘ └─────┘ └─────┘   │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 分布式部署

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web UI        │    │   API Server    │    │   LLM Service   │
│   (React)       │◀──▶│   (FastAPI)     │◀──▶│   (OpenAI/...)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  Vector Store   │  │  Graph Store    │  │   KV Store      │
│  (Milvus/...)   │  │  (Neo4j/...)    │  │  (Redis/...)    │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

### Docker 容器化部署

LightRAG 提供完整的 Docker 支持：

- **Dockerfile**: 构建应用镜像
- **docker-compose.yml**: 完整的服务编排
- **多环境支持**: 开发、测试、生产环境配置

## 总结

LightRAG 采用模块化、可扩展的架构设计，支持从单机到分布式的多种部署方式。通过抽象的存储接口和适配器模式，可以灵活地选择和更换不同的后端存储，满足不同规模和性能要求的应用场景。